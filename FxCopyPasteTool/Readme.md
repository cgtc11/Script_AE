
<section id="fxcopypastetool">
  <h1>FxCopyPasteTool.jsx 説明書</h1>
  <p>指定レイヤーのエフェクトから「値・キー・エクスプレッション」を取得し、スコープ内の同種エフェクトへ一括貼付します。異種を選んだ場合は確認の上で置換（削除→追加→適用）を実行します。コピー未実行で貼付を押した場合は、選択エフェクト種を削除します。</p>

  <h2>対応環境</h2>
  <ul>
    <li>After Effects 2022 以降</li>
    <li>ExtendScript / ScriptUI</li>
    <li>Windows / macOS（クリップボード連携: <code>clip</code> / <code>pbcopy/pbpaste</code> 使用）</li>
  </ul>

  <h2>主機能</h2>
  <ul>
    <li><strong>コピー:</strong> 選択レイヤーの選択エフェクトから全プロパティをパス走査で収集（値 / キー列 / 補間 / イーズ / 位置・速度接線 / 自動ベジェ / 連続 / 表情有効）し、JSON をクリップボードへ保存。</li>
    <li><strong>同種貼付:</strong> 一致する <code>matchName</code> の全インスタンスへ一括適用。</li>
    <li><strong>異種置換:</strong> 置換対象の各インスタンスを削除→同位置に新規追加→取得スナップショットを適用。対象が複数ある場合も降順処理で漏れを回避。</li>
    <li><strong>削除モード:</strong> スナップショットがない状態で貼付を実行すると、選択種のエフェクトを削除。</li>
    <li><strong>スコープ:</strong> プロジェクト全体 / 選択コンポ / 現在のレイヤから選択。</li>
    <li><strong>ロック対応:</strong> レイヤーがロックされていても一時解除して処理後に復帰。</li>
  </ul>

  <h2>UI 構成</h2>
  <ul>
    <li><strong>コピー用パネル</strong>
      <ul>
        <li>取得（レイヤー再読み込み）</li>
        <li>レイヤー選択（ドロップダウン）</li>
        <li>エフェクト選択（ドロップダウン）</li>
        <li>このエフェクトをコピー</li>
      </ul>
    </li>
    <li><strong>ペースト用パネル</strong>
      <ul>
        <li>スコープ選択: プロジェクト全体 / 選択コンポ / 現在のレイヤ</li>
        <li>エフェクト集計（スコープ内を走査し、<em>エフェクト名 / 使用数 / 状態</em> を一覧表示）</li>
        <li>貼り付け / 置換（リストの選択行が対象。複数選択可）</li>
      </ul>
    </li>
    <li>ステータス表示（処理件数や失敗数を表示）</li>
  </ul>

  <h2>インストール</h2>
  <ol>
    <li><code>FxCopyPasteTool.jsx</code> を <code>Scripts</code>（パネルとして使う場合は <code>Scripts/ScriptUI Panels</code>）に配置。</li>
    <li>AE の「環境設定 &gt; スクリプトとエクスプレッション」で「スクリプトによるファイルへの書き込みとネットワークへのアクセスを許可」を有効化。</li>
    <li>パネル型は「ウィンドウ」メニューから開く。</li>
  </ol>

  <h2>使い方フロー</h2>
  <ol>
    <li>コピーしたいエフェクトを含むレイヤーがあるコンポをアクティブにする。</li>
    <li>「取得（レイヤー再読み込み）」→ レイヤーとエフェクトをプルダウンで選択。</li>
    <li>「このエフェクトをコピー」→ スナップショットがメモリとクリップボードに保存される。</li>
    <li>貼付先スコープを選び「エフェクト集計」→ 対象のエフェクト行を選択（複数可）。</li>
    <li>「貼り付け / 置換」を押す。
      <ul>
        <li>同種はそのまま貼付。</li>
        <li>異種が含まれる場合は確認ダイアログ後に置換。</li>
        <li>コピーを実行していない場合は削除として動作。</li>
      </ul>
    </li>
  </ol>

  <h2>データ仕様</h2>
  <p>クリップボードには JSON を保存します（例）。</p>
  <pre><code>{
  "effectMatchName": "ADBE Gaussian Blur 2",
  "effectDisplayName": "ブラー（ガウス）",
  "items": [
    { "path":[1,2,3], "matchName":"ADBE Slider Control-0001",
      "value": 35.0,
      "keys":[{"t":0.0,"v":0},{"t":1.0,"v":35}],
      "expr":{"enabled":false,"value":""}
    },
    …
  ]
}</code></pre>
  <ul>
    <li><code>path</code>: エフェクト直下からのインデックス経路。</li>
    <li><code>keys</code>: 時間・値・補間・イーズ・ロービング・空間接線などを可能な範囲で保存。</li>
    <li><code>expr</code>: エクスプレッション文字列と有効状態。</li>
  </ul>

  <h2>実装の要点</h2>
  <ul>
    <li>コピーはエフェクト内部を再帰走査し、Property ごとに「値/キー/式」を採取。</li>
    <li>貼付は保存した <code>path</code> に従ってプロパティへ到達して適用。</li>
    <li>同名末尾の番号（「 2」「 3」など）は表示名から除去して集計。</li>
    <li>置換時は毎回最新のインデックス一覧を収集し、降順で削除→追加→同位置へ移動→適用。</li>
    <li>レイヤーロックは一時解除して復帰。</li>
  </ul>

  <h2>既知の制約</h2>
  <ul>
    <li>一部サードパーティ効果の非公開プロパティは取得/適用に失敗する場合がある。</li>
    <li>プロパティ構造が AE バージョンで変わると <code>path</code> が一致しない可能性がある。</li>
    <li>クリップボードの外部改変や巨大データは OS 側制限に影響される。</li>
  </ul>

  <h2>トラブル対処</h2>
  <ul>
    <li><strong>「コピー完了(クリップボード書込失敗)」が出る:</strong> JSON は内部には保持される。別プロセスのクリップボード占有を解除して再実行。</li>
    <li><strong>貼付先に一部だけ反映される:</strong> 異種選択のままになっていないか確認し、リストで正しい行を選ぶ。</li>
    <li><strong>置換がスキップされる:</strong> 追加失敗カウントが増える場合は、エフェクトのインストールやライセンス状態を確認。</li>
  </ul>

  <h2>出力ログ（ステータス例）</h2>
  <pre><code>適用: 12/148  置換: 5/67  失敗: 0  ロック: 3</code></pre>

  <h2>ライセンス / 免責</h2>
  <p>プロジェクトの複製で検証してから運用してください。各エフェクトの仕様変更により結果が変わる可能性があります。</p>

  <h2>更新履歴</h2>
  <ul>
    <li>2025-11-10: ドキュメント初版。</li>
  </ul>
</section>
